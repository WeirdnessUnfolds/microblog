name: Security Checks

# Trigger manually using workflow_dispatch
on:
  workflow_dispatch:   # Allows manual triggering of the workflow

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Set up Docker Buildx for Docker builds (if needed)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Install necessary tools (Bandit, Trivy, Dockle)
      - name: Install dependencies (Bandit, Trivy, and Dockle)
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y make curl wget python3-pip docker.io

          # Install Bandit (Python security checks)
          pip install bandit

          # Install Trivy (Docker image security scanner)
          curl -s https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo bash

          # Install Dockle (Dockerfile security checker)
          curl -s https://github.com/goodwithtech/dockle/releases/download/v0.4.0/dockle-linux-amd64.tar.gz | tar xz && sudo mv dockle /usr/local/bin

      # Run the Bandit security scan using makefile target
      - name: Run Bandit Security Scan
        run: make bandit  # This assumes you have a 'bandit' target in your Makefile

      # Run the Trivy image scan using makefile target
      - name: Run Trivy Image Scan
        run: make image-scan  # This assumes you have an 'image-scan' target in your Makefile

      # Run Dockle security scan using makefile target
      - name: Run Dockle Security Scan
        run: make dockle  # This assumes you have a 'dockle' target in your Makefile

      # Optional: Print Bandit Report if needed
      - name: Print Bandit Report
        run: |
          if [ -f bandit-report.html ]; then cat bandit-report.html; fi
