name: Security Checks

# Trigger manually using workflow_dispatch
on:
  workflow_dispatch:   # Allows manual triggering of the workflow

jobs:
  security-checks:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Set up Docker Buildx for Docker builds
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Install dependencies: Make, Docker, Python, and other required tools
      - name: Install dependencies and remove conflicting containerd
        run: |
          # Remove any existing containerd package to avoid conflicts
          sudo apt-get remove -y containerd
          sudo apt-get autoremove -y
          sudo apt-get purge -y containerd

          # Ensure that any lingering containerd dependencies are cleaned up
          sudo dpkg --purge containerd

          # Update apt package list
          sudo apt-get update -qq

          # Install necessary dependencies
          sudo apt-get install -y make docker.io curl wget python3-pip

          # Install Bandit (Python security checks)
          pip install bandit

          # Install Trivy (Docker image security scanner)
          curl -s https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo bash

          # Install Docker (in case it's not already installed)
          curl -fsSL https://get.docker.com | sudo sh

      # Run the Bandit security scan using makefile target
      - name: Run Bandit Security Scan
        run: make bandit  # This assumes you have a 'bandit' target in your Makefile

      # Run the Trivy image scan using makefile target
      - name: Run Trivy Image Scan
        run: make image-scan  # This assumes you have an 'image-scan' target in your Makefile

      # Run Dockle security scan using makefile target
      - name: Run Dockle Security Scan
        run: make dockle  # This assumes you have a 'dockle' target in your Makefile

      # Optional: Print Bandit Report if needed
      - name: Print Bandit Report
        run: |
          if [ -f bandit-report.html ]; then cat bandit-report.html; fi
